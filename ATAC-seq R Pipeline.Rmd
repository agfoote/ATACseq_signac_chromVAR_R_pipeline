---
title: "ATAC-seq Processing Pipeline using Signac and Seurat"
author: "Alexander G. Foote"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Introduction

This pipeline processes raw ATAC-seq data from 10x Genomics. It includes steps for data loading, quality control (QC), doublet detection, normalization, dimensionality reduction, clustering, generating gene activity matrices, and saving processed objects. The analysis uses the Signac and Seurat frameworks for single-cell ATAC-seq data.

## 2. Data Loading and Object Creation

Load the raw count matrix and metadata from your 10x output, then create a ChromatinAssay and Seurat object. Also, add gene annotations using EnsDb.
```{r package-load}
library(Signac)
library(Seurat)
library(EnsDb.Mmusculus.v79)
library(GenomicRanges)
library(ggplot2)
library(patchwork)
library(Matrix)
```

```{r data-loading}
# Load counts from 10x H5 file and metadata from a CSV file
counts <- Read10X_h5("/Users/alexanderfoote/dev/Projs/R/ATAC-seq_Le_dataset/filtered_peak_bc_matrix.h5")
metadata <- read.csv(file = "/Users/alexanderfoote/dev/Projs/R/ATAC-seq_Le_dataset/singlecell.csv", header = TRUE, row.names = 1)

# Create the Chromatin Assay object for ATAC-seq data.
lung_assay <- CreateChromatinAssay(
  counts = counts,
  sep = c(":", "-"),
  genome = "mm10",
  fragments = '/Users/alexanderfoote/dev/Projs/R/ATAC-seq_Le_dataset/fragments.tsv.gz',
  min.cells = 1
)

# Create a Seurat object with the chromatin assay and add metadata.
snATAC <- CreateSeuratObject(
  counts = lung_assay,
  assay = 'peaks',
  project = 'P8_rep1',
  meta.data = metadata
)

# Extract gene annotations from EnsDb and convert to UCSC style.
annotations <- GetGRangesFromEnsDb(ensdb = EnsDb.Mmusculus.v79)
seqlevelsStyle(annotations) <- 'UCSC'
Annotation(snATAC) <- annotations

# Save raw object
setwd('/Users/alexanderfoote/dev/Projs/R/ATAC-seq_Le_dataset/rds')
saveRDS(snATAC, file = "Control_mesen_snATAC_Signac_raw_08282022.rds")
```

## 3. Quality Control (QC) and Fragment Analysis

Compute QC metrics including nucleosome signal and TSS enrichment, visualize the fragment histogram and TSS plot, and generate violin plots for QC metrics.
```{r qc-metrics}
# Compute nucleosome signal and group cells based on nucleosome signal.
snATAC <- NucleosomeSignal(object = snATAC)
snATAC$nucleosome_group <- ifelse(snATAC$nucleosome_signal > 4, 'NS > 4', 'NS < 4')

# Define a base name for output files
name <- "P8_mesenATAC_rep1"
# Plot fragment histogram
pdf(paste0(name, "_FragHistogram.pdf"))
FragmentHistogram(object = snATAC, group.by = 'nucleosome_group', region = 'chr1-1-10000000')
dev.off()

# Compute TSS enrichment and create a grouping based on TSS score
DefaultAssay(snATAC) <- "peaks"
options(future.globals.maxSize = 8 * 1024^3)  # sets the limit to 8 GiB
snATAC <- TSSEnrichment(snATAC)
snATAC$high.tss <- ifelse(snATAC$TSS.enrichment > 2, 'High', 'Low')

# Generate TSS enrichment plot
pdf(paste0(name, "_TSSplot.pdf"))
TSSPlot(snATAC, group.by = 'high.tss') + NoLegend()
dev.off()

# Compute additional QC metrics
snATAC$pct_reads_in_peaks <- snATAC$peak_region_fragments / snATAC$passed_filters * 100
snATAC$blacklist_ratio <- snATAC$blacklist_region_fragments / snATAC$peak_region_fragments

# Plot QC metrics as violin plots
pdf(paste0(name, "_QC-Vlnplot.pdf"))
VlnPlot(object = snATAC, features = c('pct_reads_in_peaks','peak_region_fragments','TSS.enrichment','blacklist_ratio','nucleosome_signal'),
        pt.size = 0, ncol = 5)
dev.off()

# Remove cells that are outliers based on QC metrics (Filtering Low-Quality Cells)
snATAC <- subset(x = snATAC, subset = peak_region_fragments > 3000 & peak_region_fragments < 50000 &
                                     pct_reads_in_peaks > 30 & blacklist_ratio < 0.05 &
                                     nucleosome_signal < 5 & TSS.enrichment > 2)
snATAC
```

## 4. Normalization and Dimensionality Reduction

Run TF-IDF normalization, find top features, perform singular value decomposition (SVD) for dimensionality reduction, and check the depth correlation.
```{r normalization-dimred}
# Normalize using TF-IDF and find top features
snATAC <- RunTFIDF(snATAC)
snATAC <- FindTopFeatures(snATAC, min.cutoff = 'q0')

# Run SVD (LSI) for dimensionality reduction
snATAC <- RunSVD(object = snATAC, reduction.key = "LSI_", reduction.name = "lsi")

# Plot depth correlation to inspect the first LSI component
pdf(paste0(name, "_DepthCor.pdf"))
DepthCor(snATAC)
dev.off()
```

## 5. Non-linear Dimensionality Reduction and Clustering

Run UMAP, compute neighbors, perform Leiden clustering, and visualize the clusters.
```{r clustering-umap}
# Run UMAP on LSI dimensions (excluding the first component)
snATAC <- RunUMAP(object = snATAC, reduction = 'lsi', dims = 2:30)
# Find neighbors and cluster the cells
snATAC <- FindNeighbors(snATAC, reduction = 'lsi', dims = 2:30)
snATAC <- FindClusters(snATAC, algorithm = 3, resolution = 0.5, verbose = FALSE)
# Generate UMAP plot with cluster labels
setwd('/Users/alexanderfoote/dev/Projs/R/ATAC-seq_Le_dataset/plots')
pdf(paste0(name, "_UMAP.pdf"))
DimPlot(object = snATAC, label = TRUE, pt.size = 0.15) + NoLegend()
dev.off()
```

## 6. Gene Activity Matrix and RNA Assay

Compute a gene activity matrix, add it as a new assay to the Seurat object, normalize the data in this assay, and visualize gene expression.
```{r gene-activity}
# Compute the gene activity matrix
gene.activities <- GeneActivity(snATAC)
# Add the gene activity matrix as a new assay to the Seurat object
snATAC[['RNA']] <- CreateAssayObject(counts = gene.activities)
snATAC <- NormalizeData(snATAC, assay = 'RNA', normalization.method = 'LogNormalize', 
                        scale.factor = median(snATAC$nCount_RNA))
DefaultAssay(snATAC) <- 'RNA'

# Generate feature plots for selected genes
pdf(paste0(name, "_Featureplot-Ptprc.pdf"))
FeaturePlot(snATAC, features = c("Ptprc"), order = TRUE, pt.size = 0.1)
dev.off()

pdf(paste0(name, "_Featureplot-Col1a1.pdf"))
FeaturePlot(snATAC, features = c("Col1a1"), order = TRUE, pt.size = 0.1)
dev.off()
```

## 7. Save Final Processed Object

Save the fully processed object and a subset of clusters for further analysis.
```{r save-objects}
# Save the full processed object
saveRDS(snATAC, file = "P8_mesenATAC_rep1_res0-5_03052023.rds")

# Create and save a refined subset containing selected clusters
subset <- subset(snATAC, idents = c(0,1,2,3,4,5,6,7,8,10))
saveRDS(subset, file = "P8_mesenATAC_rep1_res0-5_refine_03062023.rds")
```